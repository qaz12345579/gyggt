local rs = game:GetService("ReplicatedStorage")
local ps = game:GetService("Players")
local cam = workspace.CurrentCamera

-- Utility 모듈이 없는 경우를 대비한 안전장치
local util
pcall(function()
    util = require(rs:WaitForChild("Modules").Utility)
end)

if not util then
    warn("Utility 모듈을 찾을 수 없습니다.")
    return
end

-- 엔티티 캐싱을 위한 테이블
local ents = {}
local lastScan = 0
local SCAN_INTERVAL = 0.5 -- 0.5초마다 스캔

-- 효율적인 엔티티 스캔 함수
local function scan()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then
        return ents
    end
    
    lastScan = now
    ents = {}
    
    -- 두 가지 방법으로 엔티티 수집
    for _, v in pairs(workspace:GetChildren()) do
        -- 방법 1: Humanoid가 있는 객체 (플레이어, NPC)
        if v:FindFirstChildOfClass("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
            if v ~= ps.LocalPlayer.Character then
                table.insert(ents, v)
            end
        
        -- 방법 2: HurtEffect 내 객체
        elseif v.Name == "HurtEffect" then
            for _, hv in pairs(v:GetChildren()) do
                if hv.ClassName ~= "Highlight" and hv:IsA("BasePart") then
                    table.insert(ents, hv.Parent or hv)
                end
            end
        end
    end
    
    return ents
end

-- 가장 가까운 적 찾기 (시야각 고려)
local function findClosestTarget(maxAngle)
    local char = ps.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then 
        return nil 
    end
    
    local myPos = char.HumanoidRootPart.Position
    local myForward = cam.CFrame.LookVector
    
    scan()
    local bestTarget = nil
    local bestScore = -math.huge
    
    for _, target in pairs(ents) do
        if target == char then continue end
        
        local root = target:FindFirstChild("HumanoidRootPart")
        if not root then continue end
        
        -- 1. 거리 계산
        local distance = (root.Position - myPos).Magnitude
        
        -- 2. 시야각 계산
        local toTarget = (root.Position - myPos).Unit
        local dot = myForward:Dot(toTarget)
        local angle = math.deg(math.acos(math.clamp(dot, -1, 1)))
        
        -- 3. 화면 내 위치 확인
        local screenPos, onScreen = cam:WorldToViewportPoint(root.Position)
        if not onScreen then continue end
        
        -- 4. 시야각 제한 적용
        if maxAngle and angle > maxAngle then continue end
        
        -- 5. 종합 점수 계산 (거리, 시야각, 화면 중앙과의 거리)
        local screenCenter = cam.ViewportSize / 2
        local screenDist = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
        
        local score = (1000 / distance) - (screenDist * 0.1) - (angle * 0.05)
        
        if score > bestScore then
            bestScore = score
            bestTarget = target
        end
    end
    
    return bestTarget
end

-- Raycast 후킹 (교육용 예시)
local originalRaycast = util.Raycast
util.Raycast = function(raycastParams, origin, direction, maxDistance, filterCallback, collisionGroup, visualize)
    -- 특정 조건에서만 조작 (예: 저격총의 긴 사거리)
    if maxDistance and maxDistance > 500 then
        local target = findClosestTarget(30) -- 30도 시야각 내
        
        if target and target:FindFirstChild("Head") then
            -- 실제 Raycast를 먼저 수행
            local realResult = originalRaycast(
                raycastParams, origin, direction, 
                maxDistance, filterCallback, 
                collisionGroup, visualize
            )
            
            -- Raycast가 적중하지 않았거나 다른 물체를 맞췄을 경우
            if not realResult or 
               (realResult.Instance ~= target.Head and 
                not realResult.Instance:IsDescendantOf(target)) then
                
                -- 조준 보정 (더 자연스럽게)
                local headPos = target.Head.Position
                local distanceToHead = (headPos - origin).Magnitude
                
                if distanceToHead <= maxDistance then
                    return {
                        Position = headPos,
                        Distance = distanceToHead,
                        Instance = target.Head,
                        Material = target.Head.Material,
                        Normal = (headPos - origin).Unit
                    }
                end
            end
        end
    end
    
    -- 기본 Raycast 수행
    return originalRaycast(
        raycastParams, origin, direction, 
        maxDistance, filterCallback, 
        collisionGroup, visualize
    )
end

-- 청소 함수
game.Players.LocalPlayer.CharacterRemoving:Connect(function()
    util.Raycast = originalRaycast
end)
