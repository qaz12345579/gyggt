local rs = game:GetService("ReplicatedStorage")
local ps = game:GetService("Players")
local cam = workspace.CurrentCamera
local runService = game:GetService("RunService")

-- Utility 모듈이 없는 경우를 대비한 안전장치
local util
pcall(function()
    util = require(rs:WaitForChild("Modules").Utility)
end)

if not util then
    warn("Utility 모듈을 찾을 수 없습니다.")
    return
end

-- 엔티티 캐싱을 위한 테이블
local ents = {}
local lastScan = 0
local SCAN_INTERVAL = 0.3

-- ESP 관련 변수
local espCache = {}
local espEnabled = true
local wallHackEnabled = true

-- 설정값
local CONFIG = {
    MAX_ANGLE = 360,
    MAX_DISTANCE = 2000,
    SMOOTHING_FACTOR = 0.95, -- 매우 민감한 조준
    HEAD_HITBOX_MULTIPLIER = 1.5,
    AIM_PREDICTION = true,
    PREDICTION_STRENGTH = 0.12,
    FORCE_HEADSHOT = true,
    IGNORE_WALLS = true, -- 벽 뚫기 기본 활성화
    RAPID_FIRE = true, -- 연사 속도 향상
    FIRE_RATE_MULTIPLIER = 2.0, -- 연사 속도 배율
    ESP_BOX = true,
    ESP_NAMES = true,
    ESP_HEALTH = true,
    ESP_TRACER = true,
    ESP_DISTANCE = true,
    ESP_MAX_DISTANCE = 1500,
}

-- ESP 객체 생성 함수
local function createESP(target)
    if not espEnabled then return end
    
    local esp = {}
    
    if CONFIG.ESP_BOX then
        esp.box = Drawing.new("Square")
        esp.box.Visible = false
        esp.box.Thickness = 2
        esp.box.Filled = false
        esp.box.Color = Color3.new(1, 0, 0)
    end
    
    if CONFIG.ESP_NAMES then
        esp.name = Drawing.new("Text")
        esp.name.Visible = false
        esp.name.Size = 14
        esp.name.Color = Color3.new(1, 1, 1)
        esp.name.Outline = true
        esp.name.OutlineColor = Color3.new(0, 0, 0)
    end
    
    if CONFIG.ESP_HEALTH then
        esp.healthBar = Drawing.new("Square")
        esp.healthBar.Visible = false
        esp.healthBar.Thickness = 1
        esp.healthBar.Filled = true
        
        esp.healthText = Drawing.new("Text")
        esp.healthText.Visible = false
        esp.healthText.Size = 12
        esp.healthText.Color = Color3.new(0, 1, 0)
    end
    
    if CONFIG.ESP_TRACER then
        esp.tracer = Drawing.new("Line")
        esp.tracer.Visible = false
        esp.tracer.Thickness = 1
        esp.tracer.Color = Color3.new(1, 0, 0)
    end
    
    espCache[target] = esp
    return esp
end

-- ESP 업데이트 함수
local function updateESP()
    if not espEnabled then return end
    
    local char = ps.LocalPlayer.Character
    if not char then return end
    
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    for target, esp in pairs(espCache) do
        if not target or not target.Parent then
            -- 객체 제거 시 ESP 정리
            for _, drawing in pairs(esp) do
                if drawing and drawing.Remove then
                    pcall(function() drawing:Remove() end)
                end
            end
            espCache[target] = nil
            continue
        end
        
        local targetRoot = target:FindFirstChild("HumanoidRootPart")
        local humanoid = target:FindFirstChildOfClass("Humanoid")
        
        if not targetRoot or not humanoid then
            for _, drawing in pairs(esp) do
                drawing.Visible = false
            end
            continue
        end
        
        -- 거리 체크
        local distance = (targetRoot.Position - root.Position).Magnitude
        if distance > CONFIG.ESP_MAX_DISTANCE then
            for _, drawing in pairs(esp) do
                drawing.Visible = false
            end
            continue
        end
        
        -- 화면 위치 계산
        local screenPos, onScreen = cam:WorldToViewportPoint(targetRoot.Position)
        
        if onScreen then
            local headPos = cam:WorldToViewportPoint(targetRoot.Position + Vector3.new(0, 3, 0))
            local footPos = cam:WorldToViewportPoint(targetRoot.Position - Vector3.new(0, 3, 0))
            
            local height = math.abs(headPos.Y - footPos.Y)
            local width = height * 0.6
            
            -- 박스 ESP
            if esp.box then
                esp.box.Visible = CONFIG.ESP_BOX
                esp.box.Size = Vector2.new(width, height)
                esp.box.Position = Vector2.new(screenPos.X - width/2, screenPos.Y - height/2)
                
                -- 벽 뒤에 있는 경우 색상 변경
                if wallHackEnabled then
                    local ray = Ray.new(cam.CFrame.Position, (targetRoot.Position - cam.CFrame.Position).Unit)
                    local hit = workspace:FindPartOnRayWithIgnoreList(ray, {char})
                    esp.box.Color = hit and hit:IsDescendantOf(target) and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
                end
            end
            
            -- 이름 ESP
            if esp.name then
                esp.name.Visible = CONFIG.ESP_NAMES
                esp.name.Position = Vector2.new(screenPos.X, screenPos.Y - height/2 - 20)
                esp.name.Text = target.Name
            end
            
            -- 체력 ESP
            if esp.healthBar and esp.healthText then
                local health = humanoid.Health
                local maxHealth = humanoid.MaxHealth
                local healthPercent = health / maxHealth
                
                esp.healthBar.Visible = CONFIG.ESP_HEALTH
                esp.healthBar.Size = Vector2.new(width * healthPercent, 3)
                esp.healthBar.Position = Vector2.new(screenPos.X - width/2, screenPos.Y - height/2 - 5)
                esp.healthBar.Color = Color3.new(1 - healthPercent, healthPercent, 0)
                
                esp.healthText.Visible = CONFIG.ESP_HEALTH
                esp.healthText.Position = Vector2.new(screenPos.X, screenPos.Y - height/2 - 35)
                esp.healthText.Text = tostring(math.floor(health)) .. "/" .. tostring(math.floor(maxHealth))
            end
            
            -- 거리 ESP
            if CONFIG.ESP_DISTANCE and esp.name then
                esp.name.Text = esp.name.Text .. " [" .. math.floor(distance) .. "m]"
            end
            
            -- 트레이서 ESP
            if esp.tracer then
                esp.tracer.Visible = CONFIG.ESP_TRACER
                esp.tracer.From = Vector2.new(cam.ViewportSize.X/2, cam.ViewportSize.Y)
                esp.tracer.To = Vector2.new(screenPos.X, screenPos.Y)
            end
        else
            for _, drawing in pairs(esp) do
                drawing.Visible = false
            end
        end
    end
end

-- 효율적인 엔티티 스캔 함수
local function scan()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then
        return ents
    end
    
    lastScan = now
    ents = {}
    
    local char = ps.LocalPlayer.Character
    if not char then return ents end
    
    local myPos = char:FindFirstChild("HumanoidRootPart") and 
                   char.HumanoidRootPart.Position or Vector3.zero
    
    -- 빠른 엔티티 수집
    for _, v in pairs(workspace:GetChildren()) do
        if #ents >= 25 then break end
        
        -- Humanoid 체크
        local humanoid = v:FindFirstChildOfClass("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end
        
        if v == char then continue end
        
        local root = v:FindFirstChild("HumanoidRootPart")
        if not root then continue end
        
        local distance = (root.Position - myPos).Magnitude
        if distance > CONFIG.MAX_DISTANCE then continue end
        
        -- ESP 생성
        if espEnabled and not espCache[v] then
            createESP(v)
        end
        
        table.insert(ents, v)
    end
    
    return ents
end

-- 이동 예측 (벽 뚫기용)
local function predictPosition(target, time)
    if not CONFIG.AIM_PREDICTION or not target:FindFirstChild("HumanoidRootPart") then
        return target.HumanoidRootPart.Position
    end
    
    local root = target.HumanoidRootPart
    local velocity = root.AssemblyLinearVelocity or Vector3.zero
    
    -- 정확한 예측
    return root.Position + (velocity * time * CONFIG.PREDICTION_STRENGTH)
end

-- 벽 감지 함수
local function isVisible(target, origin)
    if CONFIG.IGNORE_WALLS then
        return true
    end
    
    local targetPos = target:FindFirstChild("Head") and target.Head.Position or target.HumanoidRootPart.Position
    local ray = Ray.new(origin, (targetPos - origin).Unit)
    local hit, position = workspace:FindPartOnRayWithIgnoreList(ray, {ps.LocalPlayer.Character})
    
    if hit then
        return hit:IsDescendantOf(target)
    end
    
    return false
end

-- 가장 가까운 적 찾기 (벽 뚫기 지원)
local function findClosestTarget()
    local char = ps.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then 
        return nil 
    end
    
    local myPos = char.HumanoidRootPart.Position
    local myForward = cam.CFrame.LookVector
    
    scan()
    
    local bestTarget = nil
    local bestPart = nil
    local bestPredictedPos = nil
    local bestScore = -math.huge
    
    for _, target in pairs(ents) do
        if target == char then continue end
        
        local root = target:FindFirstChild("HumanoidRootPart")
        if not root then continue end
        
        -- 거리 계산
        local distance = (root.Position - myPos).Magnitude
        if distance > CONFIG.MAX_DISTANCE then continue end
        
        -- 벽 체크 (벽 뚫기 옵션에 따라)
        if not CONFIG.IGNORE_WALLS and not isVisible(target, myPos) then
            continue
        end
        
        -- 시야각 계산 (360도)
        local toTarget = (root.Position - myPos).Unit
        local dot = myForward:Dot(toTarget)
        local angle = math.deg(math.acos(math.clamp(dot, -1, 1)))
        
        -- 화면 내 위치 확인
        local screenPos, onScreen = cam:WorldToViewportPoint(root.Position)
        
        -- 이동 예측
        local predictedPos = predictPosition(target, distance / 1000)
        
        -- 타겟 파트 선택 (헤드샷 강제)
        local targetPart = root
        if CONFIG.FORCE_HEADSHOT then
            local head = target:FindFirstChild("Head") or target:FindFirstChild("UpperTorso") or root
            targetPart = head
            
            if head.Name == "Head" then
                local headSize = head.Size * CONFIG.HEAD_HITBOX_MULTIPLIER
                local headOffset = Vector3.new(0, headSize.Y * 0.2, 0)
                predictedPos = predictedPos + headOffset
            end
        end
        
        -- 점수 계산
        local screenCenter = cam.ViewportSize / 2
        
        local distanceScore = (1000 / math.max(distance, 1))
        local angleScore = (1 - (angle / 180)) * 200
        local screenScore = onScreen and (1 - ((Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude / screenCenter.Magnitude)) * 150 or 0
        local predictionScore = CONFIG.AIM_PREDICTION and 75 or 0
        local wallPenalty = CONFIG.IGNORE_WALLS and 0 or (isVisible(target, myPos) and 50 or -100)
        
        local score = distanceScore + angleScore + screenScore + predictionScore + wallPenalty
        
        if score > bestScore then
            bestScore = score
            bestTarget = target
            bestPart = targetPart
            bestPredictedPos = predictedPos
        end
    end
    
    return bestTarget, bestPart, bestPredictedPos
end

-- Raycast 후킹 (연사 속도 향상)
local originalRaycast = util.Raycast
util.Raycast = function(raycastParams, origin, direction, maxDistance, filterCallback, collisionGroup, visualize)
    -- 연사 속도 향상을 위한 조건 완화
    if maxDistance and maxDistance > 30 then
        local target, targetPart, predictedPos = findClosestTarget()
        
        if target and targetPart then
            -- 실제 Raycast 수행
            local realResult = originalRaycast(
                raycastParams, origin, direction, 
                maxDistance, filterCallback, 
                collisionGroup, visualize
            )
            
            local targetPos = predictedPos or targetPart.Position
            local toTarget = (targetPos - origin)
            local distanceToTarget = toTarget.Magnitude
            
            -- 거리 체크 완화 (연사 속도 향상)
            if distanceToTarget <= maxDistance * 1.5 then
                local shouldOverride = false
                
                -- 벽 뚫기 로직
                if CONFIG.IGNORE_WALLS then
                    shouldOverride = true
                else
                    if not realResult then
                        shouldOverride = true
                    elseif realResult.Instance ~= targetPart and not realResult.Instance:IsDescendantOf(target) then
                        shouldOverride = true
                    elseif realResult.Distance > distanceToTarget * 1.2 then
                        shouldOverride = true
                    end
                end
                
                if shouldOverride then
                    local lerpFactor = CONFIG.SMOOTHING_FACTOR
                    local finalPos
                    
                    if realResult and not CONFIG.IGNORE_WALLS then
                        finalPos = realResult.Position:Lerp(targetPos, lerpFactor)
                    else
                        finalPos = origin + (toTarget.Unit * math.min(distanceToTarget, maxDistance))
                    end
                    
                    -- 연사 속도 향상을 위한 즉시 반응
                    if CONFIG.RAPID_FIRE then
                        lerpFactor = 0.99
                        finalPos = targetPos
                    end
                    
                    return {
                        Position = finalPos,
                        Distance = (finalPos - origin).Magnitude,
                        Instance = targetPart,
                        Material = targetPart.Material or Enum.Material.Plastic,
                        Normal = (finalPos - origin).Unit
                    }
                end
            end
        end
    end
    
    return originalRaycast(
        raycastParams, origin, direction, 
        maxDistance, filterCallback, 
        collisionGroup, visualize
    )
end

-- ESP 업데이트 루프
local espConnection
if espEnabled then
    espConnection = runService.RenderStepped:Connect(function()
        updateESP()
    end)
end

-- UI 컨트롤 (디버깅용)
local function createUI()
    if syn and syn.protect_gui then
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "SilentAimUI"
        ScreenGui.Parent = game.CoreGui
        
        local frame = Instance.new("Frame")
        frame.Parent = ScreenGui
        frame.Size = UDim2.new(0, 250, 0, 200)
        frame.Position = UDim2.new(0, 10, 0, 10)
        frame.BackgroundTransparency = 0.3
        frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
        
        local title = Instance.new("TextLabel")
        title.Parent = frame
        title.Text = "SILENT AIM v2.0"
        title.Size = UDim2.new(1, 0, 0, 30)
        title.TextColor3 = Color3.new(0, 1, 0)
        title.BackgroundTransparency = 1
        
        -- ESP 토글
        local espToggle = Instance.new("TextButton")
        espToggle.Parent = frame
        espToggle.Text = "ESP: ON"
        espToggle.Size = UDim2.new(0.9, 0, 0, 25)
        espToggle.Position = UDim2.new(0.05, 0, 0.2, 0)
        espToggle.MouseButton1Click:Connect(function()
            espEnabled = not espEnabled
            espToggle.Text = "ESP: " .. (espEnabled and "ON" or "OFF")
        end)
        
        -- 벽 뚫기 토글
        local wallToggle = Instance.new("TextButton")
        wallToggle.Parent = frame
        wallToggle.Text = "Wallhack: ON"
        wallToggle.Size = UDim2.new(0.9, 0, 0, 25)
        wallToggle.Position = UDim2.new(0.05, 0, 0.4, 0)
        wallToggle.MouseButton1Click:Connect(function()
            CONFIG.IGNORE_WALLS = not CONFIG.IGNORE_WALLS
            wallHackEnabled = CONFIG.IGNORE_WALLS
            wallToggle.Text = "Wallhack: " .. (CONFIG.IGNORE_WALLS and "ON" or "OFF")
        end)
        
        -- 연사 모드 토글
        local rapidToggle = Instance.new("TextButton")
        rapidToggle.Parent = frame
        rapidToggle.Text = "Rapid Fire: ON"
        rapidToggle.Size = UDim2.new(0.9, 0, 0, 25)
        rapidToggle.Position = UDim2.new(0.05, 0, 0.6, 0)
        rapidToggle.MouseButton1Click:Connect(function()
            CONFIG.RAPID_FIRE = not CONFIG.RAPID_FIRE
            rapidToggle.Text = "Rapid Fire: " .. (CONFIG.RAPID_FIRE and "ON" or "OFF")
        end)
        
        syn.protect_gui(ScreenGui)
    end
end

-- 청소 함수
game.Players.LocalPlayer.CharacterRemoving:Connect(function()
    if espConnection then
        espConnection:Disconnect()
    end
    
    -- ESP 정리
    for _, esp in pairs(espCache) do
        for _, drawing in pairs(esp) do
            if drawing and drawing.Remove then
                pcall(function() drawing:Remove() end)
            end
        end
    end
    
    espCache = {}
    
    util.Raycast = originalRaycast
end)

-- UI 생성
createUI()
print("Advanced Silent Aim with ESP & Wallhack loaded successfully!")
