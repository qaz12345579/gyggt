
local rs = game:GetService("ReplicatedStorage")
local ps = game:GetService("Players")
local cam = workspace.CurrentCamera
local runService = game:GetService("RunService")
local uis = game:GetService("UserInputService")
local tweenService = game:GetService("TweenService")
local lighting = game:GetService("Lighting")
local debris = game:GetService("Debris")

-- 로컬 플레이어
local lp = ps.LocalPlayer
local mouse = lp:GetMouse()

-- 유틸리티 모듈 찾기
local util = nil
for _, v in pairs(rs:WaitForChild("Modules"):GetChildren()) do
    if v.Name:lower():find("util") or v.Name:lower():find("ray") then
        pcall(function() util = require(v) end)
        if util then break end
    end
end

if not util then
    util = {
        Raycast = function(...)
            return workspace:Raycast(...)
        end
    }
    warn("유틸리티 모듈을 찾지 못함, 기본 Raycast 사용")
end

-- 설정
local SETTINGS = {
    ENABLED = true,
    WALLBANG = true, -- 벽 뚫기
    INFINITE_RANGE = true, -- 무한 사거리
    NO_SPREAD = true, -- 반동/퍼짐 제거
    RAPID_FIRE = true, -- 연사속도 증가
    RAPID_MULTIPLIER = 3, -- 연사속도 배율
    ALWAYS_HEADSHOT = true, -- 항상 헤드샷
    SILENT_AIM = true, -- 사일런트 에임
    FOV = 120, -- 시야각
    SMOOTHING = 0.05, -- 부드러움 (낮을수록 빠름)
    VISUALS = {
        ESP = true,
        BOX_ESP = true,
        HEALTH_BAR = true,
        TRACERS = true,
        CHAMS = true,
        GLOW = true,
        NAME_TAGS = true,
        DISTANCE = true
    },
    COLORS = {
        FRIENDLY = Color3.fromRGB(50, 255, 50),
        ENEMY = Color3.fromRGB(255, 50, 50),
        CHAMS_VISIBLE = Color3.fromRGB(255, 100, 100),
        CHAMS_OCCLUDED = Color3.fromRGB(100, 100, 255),
        TRACER = Color3.fromRGB(255, 255, 100)
    }
}

-- 상태 변수
local raycastHistory = {}
local targetCache = {}
local espCache = {}
local rapidFireActive = false
local lastShot = 0
local shotCount = 0

-- 고급 UI 생성
local function createAdvancedUI()
    -- 메인 화면 GUI
    local mainGui = Instance.new("ScreenGui")
    mainGui.Name = "AdvancedCombatUI"
    mainGui.DisplayOrder = 999
    mainGui.ResetOnSpawn = false
    
    -- 배경 블러
    local blur = Instance.new("BlurEffect")
    blur.Size = 5
    blur.Parent = lighting
    
    -- 사이드 패널 (설정)
    local sidePanel = Instance.new("Frame")
    sidePanel.Name = "SidePanel"
    sidePanel.Size = UDim2.new(0, 300, 1, -40)
    sidePanel.Position = UDim2.new(0, -300, 0, 20)
    sidePanel.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    sidePanel.BackgroundTransparency = 0.1
    sidePanel.BorderSizePixel = 0
    sidePanel.ClipsDescendants = true
    
    local sideGradient = Instance.new("UIGradient")
    sideGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(30, 30, 45)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 30))
    }
    sideGradient.Rotation = 90
    sideGradient.Parent = sidePanel
    
    -- 패널 열기/닫기 버튼
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "TogglePanel"
    toggleBtn.Size = UDim2.new(0, 40, 0, 40)
    toggleBtn.Position = UDim2.new(0, 10, 0, 10)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleBtn.Text = "⚙️"
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextSize = 20
    toggleBtn.BorderSizePixel = 0
    toggleBtn.ZIndex = 10
    
    local function togglePanel()
        local goal = UDim2.new(0, 20, 0, 20)
        if sidePanel.Position.X.Offset < 0 then
            goal = UDim2.new(0, 20, 0, 20)
        else
            goal = UDim2.new(0, -300, 0, 20)
        end
        
        local tween = tweenService:Create(sidePanel, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Position = goal})
        tween:Play()
    end
    
    toggleBtn.MouseButton1Click:Connect(togglePanel)
    
    -- 타이틀
    local title = Instance.new("TextLabel")
    title.Text = "ADVANCED COMBAT SYSTEM"
    title.Size = UDim2.new(1, 0, 0, 50)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 100, 100)
    title.Font = Enum.Font.GothamBlack
    title.TextSize = 18
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextYAlignment = Enum.TextYAlignment.Center
    title.PaddingLeft = UDim.new(0, 20)
    title.Parent = sidePanel
    
    -- 설정 컨테이너
    local settingsContainer = Instance.new("ScrollingFrame")
    settingsContainer.Name = "SettingsContainer"
    settingsContainer.Size = UDim2.new(1, -20, 1, -70)
    settingsContainer.Position = UDim2.new(0, 10, 0, 50)
    settingsContainer.BackgroundTransparency = 1
    settingsContainer.ScrollBarThickness = 5
    settingsContainer.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 150)
    settingsContainer.CanvasSize = UDim2.new(0, 0, 0, 800)
    settingsContainer.Parent = sidePanel
    
    -- 토글 생성 함수
    local function createToggle(label, settingPath, default)
        local parts = settingPath:split(".")
        local current = SETTINGS
        for i = 1, #parts - 1 do
            current = current[parts[i]]
        end
        local key = parts[#parts]
        
        local toggleFrame = Instance.new("Frame")
        toggleFrame.Size = UDim2.new(1, 0, 0, 40)
        toggleFrame.BackgroundTransparency = 1
        
        local labelText = Instance.new("TextLabel")
        labelText.Text = label
        labelText.Size = UDim2.new(0.7, 0, 1, 0)
        labelText.BackgroundTransparency = 1
        labelText.TextColor3 = Color3.fromRGB(200, 200, 220)
        labelText.Font = Enum.Font.Gotham
        labelText.TextSize = 14
        labelText.TextXAlignment = Enum.TextXAlignment.Left
        labelText.Parent = toggleFrame
        
        local toggleBack = Instance.new("Frame")
        toggleBack.Size = UDim2.new(0, 50, 0, 25)
        toggleBack.Position = UDim2.new(0.7, 0, 0.5, -12.5)
        toggleBack.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
        toggleBack.BorderSizePixel = 0
        
        local toggleCircle = Instance.new("Frame")
        toggleCircle.Size = UDim2.new(0, 21, 0, 21)
        toggleCircle.Position = UDim2.new(0, 2, 0, 2)
        toggleCircle.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        toggleCircle.BorderSizePixel = 0
        
        local function updateToggle()
            local isOn = current[key]
            local goalPos = isOn and UDim2.new(0, 27, 0, 2) or UDim2.new(0, 2, 0, 2)
            local goalColor = isOn and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
            
            local tween = tweenService:Create(toggleCircle, TweenInfo.new(0.2), {
                Position = goalPos,
                BackgroundColor3 = goalColor
            })
            tween:Play()
        end
        
        updateToggle()
        
        toggleCircle.Parent = toggleBack
        toggleBack.Parent = toggleFrame
        
        toggleBack.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                current[key] = not current[key]
                updateToggle()
            end
        end)
        
        return toggleFrame
    end
    
    -- 슬라이더 생성 함수
    local function createSlider(label, settingPath, min, max, default)
        local parts = settingPath:split(".")
        local current = SETTINGS
        for i = 1, #parts - 1 do
            current = current[parts[i]]
        end
        local key = parts[#parts]
        
        local sliderFrame = Instance.new("Frame")
        sliderFrame.Size = UDim2.new(1, 0, 0, 60)
        sliderFrame.BackgroundTransparency = 1
        
        local labelText = Instance.new("TextLabel")
        labelText.Text = label
        labelText.Size = UDim2.new(1, 0, 0, 20)
        labelText.BackgroundTransparency = 1
        labelText.TextColor3 = Color3.fromRGB(200, 200, 220)
        labelText.Font = Enum.Font.Gotham
        labelText.TextSize = 14
        labelText.TextXAlignment = Enum.TextXAlignment.Left
        labelText.Parent = sliderFrame
        
        local sliderBack = Instance.new("Frame")
        sliderBack.Size = UDim2.new(1, 0, 0, 10)
        sliderBack.Position = UDim2.new(0, 0, 0, 30)
        sliderBack.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
        sliderBack.BorderSizePixel = 0
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((current[key] or default - min) / (max - min), 0, 1, 0)
        sliderFill.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
        sliderFill.BorderSizePixel = 0
        
        local sliderCircle = Instance.new("Frame")
        sliderCircle.Size = UDim2.new(0, 20, 0, 20)
        sliderCircle.Position = UDim2.new(sliderFill.Size.X.Scale, -10, 0.5, -10)
        sliderCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        sliderCircle.BorderSizePixel = 0
        
        local valueText = Instance.new("TextLabel")
        valueText.Text = tostring(current[key] or default)
        valueText.Size = UDim2.new(0, 40, 0, 20)
        valueText.Position = UDim2.new(1, 5, 0, 25)
        valueText.BackgroundTransparency = 1
        valueText.TextColor3 = Color3.fromRGB(255, 255, 255)
        valueText.Font = Enum.Font.GothamBold
        valueText.TextSize = 14
        valueText.TextXAlignment = Enum.TextXAlignment.Right
        
        local function updateSlider(value)
            value = math.clamp(value, min, max)
            current[key] = value
            local ratio = (value - min) / (max - min)
            
            sliderFill.Size = UDim2.new(ratio, 0, 1, 0)
            sliderCircle.Position = UDim2.new(ratio, -10, 0.5, -10)
            valueText.Text = string.format("%.1f", value)
        end
        
        local dragging = false
        sliderCircle.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
            end
        end)
        
        sliderCircle.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        uis.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local mousePos = uis:GetMouseLocation()
                local sliderPos = sliderBack.AbsolutePosition
                local sliderSize = sliderBack.AbsoluteSize
                
                local relativeX = math.clamp((mousePos.X - sliderPos.X) / sliderSize.X, 0, 1)
                local value = min + (relativeX * (max - min))
                updateSlider(value)
            end
        end)
        
        updateSlider(current[key] or default)
        
        sliderFill.Parent = sliderBack
        sliderCircle.Parent = sliderBack
        valueText.Parent = sliderBack
        sliderBack.Parent = sliderFrame
        
        return sliderFrame
    end
    
    -- 설정 추가
    local toggles = {
        {"활성화", "ENABLED", true},
        {"벽 뚫기", "WALLBANG", true},
        {"무한 사거리", "INFINITE_RANGE", true},
        {"반동 제거", "NO_SPREAD", true},
        {"연사속도 증가", "RAPID_FIRE", true},
        {"항상 헤드샷", "ALWAYS_HEADSHOT", true},
        {"사일런트 에임", "SILENT_AIM", true},
        {"ESP", "VISUALS.ESP", true},
        {"박스 ESP", "VISUALS.BOX_ESP", true},
        {"체력바", "VISUALS.HEALTH_BAR", true},
        {"트레이서", "VISUALS.TRACERS", true},
        {"CHAMS", "VISUALS.CHAMS", true},
        {"글로우", "VISUALS.GLOW", true},
        {"이름표", "VISUALS.NAME_TAGS", true},
        {"거리 표시", "VISUALS.DISTANCE", true}
    }
    
    local yOffset = 0
    for _, toggle in ipairs(toggles) do
        local toggleFrame = createToggle(toggle[1], toggle[2], toggle[3])
        toggleFrame.Position = UDim2.new(0, 10, 0, yOffset)
        toggleFrame.Parent = settingsContainer
        yOffset += 40
    end
    
    -- 슬라이더 추가
    local sliders = {
        {"연사속도 배율", "RAPID_MULTIPLIER", 1, 10, 3},
        {"시야각", "FOV", 30, 360, 120},
        {"부드러움", "SMOOTHING", 0, 1, 0.05}
    }
    
    for _, slider in ipairs(sliders) do
        local sliderFrame = createSlider(slider[1], slider[2], slider[3], slider[4], slider[5])
        sliderFrame.Position = UDim2.new(0, 10, 0, yOffset)
        sliderFrame.Parent = settingsContainer
        yOffset += 60
    end
    
    -- HUD (상단 정보 표시)
    local hudFrame = Instance.new("Frame")
    hudFrame.Name = "HUD"
    hudFrame.Size = UDim2.new(1, -40, 0, 80)
    hudFrame.Position = UDim2.new(0, 20, 0, 20)
    hudFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    hudFrame.BackgroundTransparency = 0.7
    hudFrame.BorderSizePixel = 0
    
    local hudGradient = Instance.new("UIGradient")
    hudGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 50, 50)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 150, 50)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 255, 50))
    }
    hudGradient.Transparency = NumberSequence.new(0.3)
    hudGradient.Parent = hudFrame
    
    local targetInfo = Instance.new("TextLabel")
    targetInfo.Name = "TargetInfo"
    targetInfo.Size = UDim2.new(1, -20, 0, 30)
    targetInfo.Position = UDim2.new(0, 10, 0, 10)
    targetInfo.BackgroundTransparency = 1
    targetInfo.TextColor3 = Color3.fromRGB(255, 255, 255)
    targetInfo.Font = Enum.Font.GothamBlack
    targetInfo.TextSize = 16
    targetInfo.Text = "타겟: 없음"
    targetInfo.TextXAlignment = Enum.TextXAlignment.Left
    targetInfo.Parent = hudFrame
    
    local statsInfo = Instance.new("TextLabel")
    statsInfo.Name = "StatsInfo"
    statsInfo.Size = UDim2.new(1, -20, 0, 30)
    statsInfo.Position = UDim2.new(0, 10, 0, 40)
    statsInfo.BackgroundTransparency = 1
    statsInfo.TextColor3 = Color3.fromRGB(200, 200, 255)
    statsInfo.Font = Enum.Font.Gotham
    statsInfo.TextSize = 14
    statsInfo.Text = "총알 수: 0 | 연사속도: 0/s"
    statsInfo.TextXAlignment = Enum.TextXAlignment.Left
    statsInfo.Parent = hudFrame
    
    -- 크로스헤어
    local crosshair = Instance.new("Frame")
    crosshair.Name = "Crosshair"
    crosshair.Size = UDim2.new(0, 20, 0, 20)
    crosshair.Position = UDim2.new(0.5, -10, 0.5, -10)
    crosshair.BackgroundTransparency = 1
    
    local lines = {}
    local offsets = {Vector2.new(0, -8), Vector2.new(0, 8), Vector2.new(-8, 0), Vector2.new(8, 0)}
    for i = 1, 4 do
        local line = Instance.new("Frame")
        line.Size = UDim2.new(0, 2, 0, 8)
        line.Position = UDim2.new(0.5, offsets[i].X, 0.5, offsets[i].Y)
        line.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        line.BorderSizePixel = 0
        line.Rotation = (i-1) * 90
        line.Parent = crosshair
        table.insert(lines, line)
    end
    
    -- 부모 설정
    sidePanel.Parent = mainGui
    toggleBtn.Parent = mainGui
    hudFrame.Parent = mainGui
    crosshair.Parent = mainGui
    
    -- 3D 월드 효과
    local function createWorldEffect()
        local part = Instance.new("Part")
        part.Size = Vector3.new(0.5, 0.5, 0.5)
        part.Transparency = 1
        part.CanCollide = false
        part.Anchored = true
        part.Parent = workspace
        
        local light = Instance.new("PointLight")
        light.Color = Color3.fromRGB(255, 100, 100)
        light.Range = 15
        light.Brightness = 2
        light.Shadows = true
        light.Parent = part
        
        debris:AddItem(part, 3)
        return part
    end
    
    -- GUI 부모 설정
    if syn and syn.protect_gui then
        syn.protect_gui(mainGui)
        mainGui.Parent = game.CoreGui
    else
        mainGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    end
    
    return {
        Main = mainGui,
        TargetInfo = targetInfo,
        StatsInfo = statsInfo,
        Crosshair = crosshair,
        Lines = lines,
        CreateWorldEffect = createWorldEffect
    }
end

-- 고급 ESP 시스템
local function createAdvancedESP(target)
    if not SETTINGS.VISUALS.ESP then return end
    if espCache[target] then return espCache[target] end
    
    local esp = {
        Box = nil,
        HealthBar = nil,
        NameTag = nil,
        DistanceTag = nil,
        Tracer = nil,
        Cham = nil,
        Glow = nil
    }
    
    -- 박스 ESP
    if SETTINGS.VISUALS.BOX_ESP then
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESPBox"
        highlight.Adornee = target
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.FillColor = SETTINGS.COLORS.ENEMY
        highlight.FillTransparency = 0.8
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.OutlineTransparency = 0
        highlight.Parent = target
        esp.Box = highlight
    end
    
    -- 체력바
    if SETTINGS.VISUALS.HEALTH_BAR then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESPHealthBar"
        billboard.Size = UDim2.new(0, 50, 0, 100)
        billboard.Adornee = target:WaitForChild("HumanoidRootPart")
        billboard.AlwaysOnTop = true
        billboard.MaxDistance = 500
        billboard.StudsOffset = Vector3.new(0, 3.5, 0)
        
        local barBack = Instance.new("Frame")
        barBack.Size = UDim2.new(1, 0, 1, 0)
        barBack.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        barBack.BackgroundTransparency = 0.3
        barBack.BorderSizePixel = 0
        
        local barFill = Instance.new("Frame")
        barFill.Size = UDim2.new(1, -4, 0.7, -4)
        barFill.Position = UDim2.new(0, 2, 0, 2)
        barFill.BackgroundColor3 = SETTINGS.COLORS.ENEMY
        barFill.BorderSizePixel = 0
        barFill.Parent = barBack
        
        barBack.Parent = billboard
        billboard.Parent = target
        esp.HealthBar = {Billboard = billboard, Fill = barFill}
    end
    
    -- 이름표 & 거리
    if SETTINGS.VISUALS.NAME_TAGS or SETTINGS.VISUALS.DISTANCE then
        local tag = Instance.new("BillboardGui")
        tag.Name = "ESPTag"
        tag.Size = UDim2.new(0, 200, 0, 40)
        tag.Adornee = target:WaitForChild("HumanoidRootPart")
        tag.AlwaysOnTop = true
        tag.MaxDistance = 1000
        tag.StudsOffset = Vector3.new(0, 4.5, 0)
        
        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        textLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
        textLabel.TextStrokeTransparency = 0
        textLabel.TextSize = 16
        textLabel.Font = Enum.Font.GothamBold
        textLabel.Parent = tag
        
        tag.Parent = target
        esp.NameTag = textLabel
    end
    
    -- 트레이서
    if SETTINGS.VISUALS.TRACERS then
        local tracer = Instance.new("Beam")
        tracer.Name = "ESPTracer"
        tracer.Color = ColorSequence.new(SETTINGS.COLORS.TRACER)
        tracer.Width0 = 1
        tracer.Width1 = 1
        tracer.Parent = workspace.Terrain
        esp.Tracer = tracer
    end
    
    -- CHAMS
    if SETTINGS.VISUALS.CHAMS then
        for _, part in pairs(target:GetChildren()) do
            if part:IsA("BasePart") then
                local cham = Instance.new("BoxHandleAdornment")
                cham.Name = "ESPCham"
                cham.Adornee = part
                cham.Size = part.Size + Vector3.new(0.1, 0.1, 0.1)
                cham.Color3 = SETTINGS.COLORS.CHAMS_VISIBLE
                cham.Transparency = 0.3
                cham.ZIndex = 1
                cham.AlwaysOnTop = true
                cham.Parent = part
            end
        end
    end
    
    -- 글로우 효과
    if SETTINGS.VISUALS.GLOW then
        local glow = Instance.new("SurfaceLight")
        glow.Name = "ESPGlow"
        glow.Color = SETTINGS.COLORS.ENEMY
        glow.Range = 10
        glow.Brightness = 1
        glow.Shadows = false
        glow.Parent = target:WaitForChild("HumanoidRootPart")
        esp.Glow = glow
    end
    
    espCache[target] = esp
    return esp
end

-- 타겟 찾기 (벽 뚫기 지원)
local function findTarget()
    local bestTarget = nil
    local bestPart = nil
    local bestScore = -math.huge
    
    local char = lp.Character
    if not char then return nil, nil end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return nil, nil end
    
    local myPos = root.Position
    
    for _, player in pairs(ps:GetPlayers()) do
        if player == lp then continue end
        local targetChar = player.Character
        if not targetChar then continue end
        
        local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
        local humanoid = targetChar:FindFirstChildOfClass("Humanoid")
        
        if targetRoot and humanoid and humanoid.Health > 0 then
            -- 거리 계산
            local distance = (targetRoot.Position - myPos).Magnitude
            if distance > 5000 then continue end
            
            -- 시야각 계산
            local screenPos, onScreen = cam:WorldToViewportPoint(targetRoot.Position)
            local dot = cam.CFrame.LookVector:Dot((targetRoot.Position - myPos).Unit)
            local angle = math.deg(math.acos(math.clamp(dot, -1, 1)))
            
            if angle > SETTINGS.FOV then continue end
            
            -- 벽 체크 (벽 뚫기가 꺼져있을 때만)
            local visible = true
            if not SETTINGS.WALLBANG then
                local raycastParams = RaycastParams.new()
                raycastParams.FilterDescendantsInstances = {char, targetChar}
                raycastParams.FilterType = Enum.RaycastFilterType.Exclude
                
                local ray = workspace:Raycast(myPos, targetRoot.Position - myPos, raycastParams)
                if ray and ray.Instance and not ray.Instance:IsDescendantOf(targetChar) then
                    visible = false
                end
            end
            
            if visible then
                -- 점수 계산
                local distanceScore = 1000 / math.max(distance, 1)
                local angleScore = (1 - (angle / SETTINGS.FOV)) * 500
                local screenScore = onScreen and 300 or 0
                
                -- 화면 중앙과의 거리
                local screenCenter = Vector2.new(cam.ViewportSize.X/2, cam.ViewportSize.Y/2)
                local screenDist = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                local centerScore = 200 / math.max(screenDist, 1)
                
                local totalScore = distanceScore + angleScore + screenScore + centerScore
                
                if totalScore > bestScore then
                    bestScore = totalScore
                    bestTarget = targetChar
                    bestPart = SETTINGS.ALWAYS_HEADSHOT and targetChar:FindFirstChild("Head") or targetRoot
                    
                    -- ESP 생성
                    createAdvancedESP(targetChar)
                end
            end
        end
    end
    
    return bestTarget, bestPart
end

-- Raycast 후킹 (벽 뚫기 + 연사속도)
local originalRaycast = util.Raycast
util.Raycast = function(...)
    if not SETTINGS.ENABLED then
        return originalRaycast(...)
    end
    
    local args = {...}
    local raycastParams, origin, direction, maxDistance = args[1], args[2], args[3], args[4]
    
    -- 무한 사거리
    if SETTINGS.INFINITE_RANGE then
        maxDistance = math.huge
    end
    
    -- 연사속도 증가
    if SETTINGS.RAPID_FIRE then
        local now = tick()
        if now - lastShot < (0.1 / SETTINGS.RAPID_MULTIPLIER) then
            -- 연사속도 제한을 무시하고 즉시 발사
            rapidFireActive = true
            shotCount += 1
        end
        lastShot = now
    end
    
    -- 타겟 찾기
    local target, targetPart = findTarget()
    
    if target and targetPart and SETTINGS.SILENT_AIM then
        local predictedPos = targetPart.Position
        local targetVelocity = targetPart.AssemblyLinearVelocity or Vector3.new(0, 0, 0)
        
        -- 이동 예측
        if targetVelocity.Magnitude > 0 then
            local distance = (targetPart.Position - origin).Magnitude
            local travelTime = distance / 1000
            predictedPos = predictedPos + (targetVelocity * travelTime * 0.5)
        end
        
        -- 부드러운 조준
        if SETTINGS.SMOOTHING > 0 then
            local currentDirection = direction.Unit
            local targetDirection = (predictedPos - origin).Unit
            local smoothedDirection = currentDirection:Lerp(targetDirection, SETTINGS.SMOOTHING)
            direction = smoothedDirection * (maxDistance or 1000)
        else
            direction = (predictedPos - origin).Unit * (maxDistance or 1000)
        end
        
        -- 벽 뚫기
        if SETTINGS.WALLBANG then
            raycastParams = raycastParams or RaycastParams.new()
            raycastParams.FilterDescendantsInstances = {}
            raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
        end
        
        -- 반동 제거
        if SETTINGS.NO_SPREAD then
            -- 방향을 완벽하게 타겟으로 설정
            direction = (predictedPos - origin).Unit * (maxDistance or 1000)
        end
    end
    
    -- Raycast 실행
    local result = originalRaycast(raycastParams, origin, direction, maxDistance, select(5, ...))
    
    -- 결과 기록
    if result then
        table.insert(raycastHistory, {
            From = origin,
            To = result.Position,
            Time = tick(),
            Hit = result.Instance
        })
    end
    
    return result
end

-- 총기 발사 함수 후킹 (연사속도 증가)
local function hookFireFunctions()
    -- RemoteEvents/RemoteFunctions 검색 및 후킹
    for _, obj in pairs(rs:GetDescendants()) do
        if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") then
            if obj.Name:lower():find("fire") or obj.Name:lower():find("shoot") or obj.Name:lower():find("attack") then
                local originalFire
                if obj:IsA("RemoteEvent") then
                    originalFire = obj.FireServer
                    obj.FireServer = function(self, ...)
                        if SETTINGS.ENABLED and SETTINGS.RAPID_FIRE then
                            -- 빠른 연사
                            for i = 1, SETTINGS.RAPID_MULTIPLIER do
                                task.spawn(function()
                                    originalFire(self, ...)
                                end)
                            end
                            return
                        end
                        return originalFire(self, ...)
                    end
                end
                print("후킹된 발사 함수:", obj.Name)
            end
        end
    end
end

-- 메인 업데이트 루프
local ui = createAdvancedUI()
hookFireFunctions()

runService.RenderStepped:Connect(function(dt)
    if not SETTINGS.ENABLED then return end
    
    -- 타겟 업데이트
    local target, targetPart = findTarget()
    
    -- UI 업데이트
    if ui.TargetInfo then
        if target then
            ui.TargetInfo.Text = "타겟: " .. (target.Parent and target.Parent.Name or "적")
            ui.TargetInfo.TextColor3 = SETTINGS.COLORS.ENEMY
        else
            ui.TargetInfo.Text = "타겟: 없음"
            ui.TargetInfo.TextColor3 = Color3.fromRGB(150, 150, 150)
        end
    end
    
    if ui.StatsInfo then
        ui.StatsInfo.Text = string.format("총알 수: %d | 연사속도: %d/s | 거리: %.1f",
            shotCount,
            math.floor(SETTINGS.RAPID_MULTIPLIER * 10),
            target and (targetPart.Position - cam.CFrame.Position).Magnitude or 0
        )
    end
    
    -- 크로스헤어 애니메이션
    if ui.Lines then
        local pulse = math.sin(tick() * 10) * 0.5 + 0.5
        for _, line in pairs(ui.Lines) do
            line.BackgroundColor3 = Color3.fromRGB(
                255 * pulse,
                50 * (1 - pulse),
                50 * (1 - pulse)
            )
        end
    end
    
    -- ESP 업데이트
    for targetChar, esp in pairs(espCache) do
        if not targetChar.Parent or not targetChar:FindFirstChild("HumanoidRootPart") then
            -- 정리
            if esp.Box then esp.Box:Destroy() end
            if esp.HealthBar then esp.HealthBar.Billboard:Destroy() end
            if esp.NameTag then esp.NameTag.Parent:Destroy() end
            if esp.Tracer then esp.Tracer:Destroy() end
            espCache[targetChar] = nil
        else
            -- 위치 업데이트
            local root = targetChar.HumanoidRootPart
            local humanoid = targetChar:FindFirstChildOfClass("Humanoid")
            
            -- 체력바
            if esp.HealthBar and humanoid then
                local healthPercent = humanoid.Health / humanoid.MaxHealth
                esp.HealthBar.Fill.Size = UDim2.new(1, -4, healthPercent * 0.7 - 4, 0)
                esp.HealthBar.Fill.BackgroundColor3 = Color3.fromRGB(
                    255 * (1 - healthPercent),
                    255 * healthPercent,
                    50
                )
            end
            
            -- 이름표
            if esp.NameTag then
                local distance = (root.Position - cam.CFrame.Position).Magnitude
                local text = ""
                if SETTINGS.VISUALS.NAME_TAGS then
                    text = targetChar.Parent.Name
                end
                if SETTINGS.VISUALS.DISTANCE then
                    text = text .. string.format("\n[%.1f studs]", distance)
                end
                esp.NameTag.Text = text
            end
            
            -- 트레이서
            if esp.Tracer then
                esp.Tracer.Attachment0 = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") and lp.Character.HumanoidRootPart:FindFirstChild("Attachment") or nil
                esp.Tracer.Attachment1 = root:FindFirstChild("Attachment") or nil
            end
        end
    end
end)

-- 키 바인딩
uis.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.Insert then
        SETTINGS.ENABLED = not SETTINGS.ENABLED
        print("시스템:", SETTINGS.ENABLED and "활성화" or "비활성화")
    elseif input.KeyCode == Enum.KeyCode.Delete then
        -- ESP 토글
        SETTINGS.VISUALS.ESP = not SETTINGS.VISUALS.ESP
        if not SETTINGS.VISUALS.ESP then
            for _, esp in pairs(espCache) do
                if esp.Box then esp.Box:Destroy() end
                if esp.HealthBar then esp.HealthBar.Billboard:Destroy() end
                if esp.NameTag then esp.NameTag.Parent:Destroy() end
                if esp.Tracer then esp.Tracer:Destroy() end
            end
            espCache = {}
        end
    elseif input.KeyCode == Enum.KeyCode.F then
        -- 벽 뚫기 토글
        SETTINGS.WALLBANG = not SETTINGS.WALLBANG
        print("벽 뚫기:", SETTINGS.WALLBANG and "활성화" or "비활성화")
    elseif input.KeyCode == Enum.KeyCode.R then
        -- 연사속도 토글
        SETTINGS.RAPID_FIRE = not SETTINGS.RAPID_FIRE
        print("연사속도 증가:", SETTINGS.RAPID_FIRE and "활성화" or "비활성화")
    end
end)

-- 정리
game.Players.LocalPlayer.CharacterRemoving:Connect(function()
    util.Raycast = originalRaycast
    if ui.Main then ui.Main:Destroy() end
    for _, esp in pairs(espCache) do
        if esp.Box then esp.Box:Destroy() end
        if esp.HealthBar then esp.HealthBar.Billboard:Destroy() end
        if esp.NameTag then esp.NameTag.Parent:Destroy() end
        if esp.Tracer then esp.Tracer:Destroy() end
    end
end)

print("========================================")
print("고급 전투 시스템 로드 완료!")
print("Insert: 시스템 토글")
print("Delete: ESP 토글")
print("F: 벽 뚫기 토글")
print("R: 연사속도 토글")
print("왼쪽 상단 ⚙️ 버튼: 설정 패널")
print("========================================")
